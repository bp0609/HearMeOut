// Prisma Schema for Daily Mood Journal

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - linked to Clerk authentication
model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique
  email     String?  @unique // Optional email for visibility, fetched from Clerk
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  moodEntries MoodEntry[]
  alerts      PatternAlert[]
  settings    UserSettings?

  @@index([clerkId])
  @@index([email])
}

// Mood Entry - one per day per user
model MoodEntry {
  id        String   @id @default(uuid())
  userId    String
  entryDate DateTime @db.Date
  dayOfWeek String // Day of week: Sun, Mon, Tue, Wed, Thu, Fri, Sat

  // Audio metadata
  audioFilePath String? // Relative path to stored audio file (nullable when deleted)
  duration      Int // Duration in seconds
  language      String  @default("en")

  // User's selected emoji (null until user selects)
  selectedEmoji String? // User's final choice from 8 emotions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities      MoodEntryActivity[]
  triggeredAlerts PatternAlert[] // Alerts that were triggered by this mood entry

  @@unique([userId, entryDate])
  @@index([userId, entryDate(sort: Desc)])
  @@index([userId, createdAt])
}

// Pattern Alerts - triggered by detection algorithm
model PatternAlert {
  id                 String    @id @default(uuid())
  userId             String
  triggeredByEntryId String // The mood entry that triggered this alert
  alertType          String // consecutive_low, sudden_drop, etc.
  detectedAt         DateTime  @default(now())
  patternDetails     Json // Metadata about the detected pattern
  dismissed          Boolean   @default(false)
  dismissedAt        DateTime?

  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  triggeredByEntry MoodEntry @relation(fields: [triggeredByEntryId], references: [id], onDelete: Cascade)

  @@index([userId, dismissed])
  @@index([userId, detectedAt(sort: Desc)])
  @@index([triggeredByEntryId])
}

// User Settings - preferences and privacy controls
model UserSettings {
  userId                String  @id
  reminderEnabled       Boolean @default(false)
  reminderTime          String? // Format: "HH:MM" (24-hour)
  interventionThreshold Int     @default(5) // Days of low mood before alert
  cloudStorageEnabled   Boolean @default(false)
  preferredLanguage     String  @default("en")

  // Audio storage consent - null means not asked yet, true/false means user decision
  audioStorageConsent Boolean? // null = not asked, true = agreed, false = denied
  consentGivenAt      DateTime? // When the user made their consent decision
  audioStorageEnabled Boolean   @default(false) // Current audio storage setting

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Activity - predefined activities that users can associate with their moods
model Activity {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., "social", "work", "workout"
  icon      String // emoji icon
  label     String // display name like "Meeting Friends"
  color     String // hex color for visualizations
  order     Int      @default(0) // display order
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  moodEntryActivities MoodEntryActivity[]

  @@index([order])
}

// Many-to-many relation between MoodEntry and Activity
model MoodEntryActivity {
  id          String   @id @default(uuid())
  moodEntryId String
  activityKey String // reference to Activity.key
  createdAt   DateTime @default(now())

  moodEntry MoodEntry @relation(fields: [moodEntryId], references: [id], onDelete: Cascade)
  activity  Activity  @relation(fields: [activityKey], references: [key], onDelete: Cascade)

  @@unique([moodEntryId, activityKey])
  @@index([moodEntryId])
  @@index([activityKey])
}
